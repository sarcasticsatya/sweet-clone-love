
## Root Cause Analysis

After examining the database and the edge function code, two clear bugs are found in `generate-quiz/index.ts` and `generate-flashcards/index.ts`:

### Bug 1: "ಇಂಗ್ಲೀಷ" (English subject in Kannada medium) generates Kannada

The `detectLanguage` function checks:
1. Does subject contain "kannada" or "ಕನ್ನಡ"? → return kannada  
2. Does subject contain "hindi" or "ಹಿಂದಿ"? → return hindi  
3. Is medium English? → return english  
4. Otherwise → return **kannada** ← BUG: "ಇಂಗ್ಲೀಷ" falls here

The subject name "ಇಂಗ್ಲೀಷ" (the Kannada word for "English") is never matched — it falls through all checks and lands at the default "Kannada medium = kannada". This caused quizzes for "DR B R AMBEDKAR" and "QUALITY OF MERCY" (English subject, Kannada medium) to generate in Kannada instead of English.

**Fix:** Add a check for "ಇಂಗ್ಲೀಷ" and "english" in the subject name → return `english` (same priority as Hindi/Kannada subject detection, before the medium fallback).

### Bug 2: Same exact bug exists in `generate-flashcards/index.ts`

The same `detectLanguage` function exists there with the identical missing "ಇಂಗ್ಲೀಷ" check.

---

## What Is Correct vs Wrong

Looking at the actual quiz data from the database:

| Subject | Medium | Current Output | Correct Output |
|---------|--------|---------------|----------------|
| ಕನ್ನಡ | Kannada | Kannada | Kannada (correct) |
| ವಿಜ್ಞಾನ | Kannada | Kannada | Kannada (correct) |
| ಇಂಗ್ಲೀಷ | Kannada | **Kannada (WRONG)** | English |
| ಹಿಂದಿ | Kannada | Hindi (correct) |
| KANNADA II LAUNGAUGE | English | Kannada (correct) |
| ENGLISH (FIRST LAUNGAUGE) | English | English (correct) |
| HINDI III LAUNGAUGE | English | Hindi (correct) |
| SCIENCE / MATHS / SOCIAL SCIENCE | English | English (correct) |

---

## Files to Change

### `supabase/functions/generate-quiz/index.ts`

Add a new priority check between the Hindi check and the medium fallback:

```
// English subject in ANY medium → English
if (normalizedSubject.includes("english") || subjectName.includes("ಇಂಗ್ಲೀಷ")) {
  return "english";
}
```

This mirrors the same pattern already used for Hindi and Kannada subjects.

### `supabase/functions/generate-flashcards/index.ts`

Apply the exact same fix to the `detectLanguage` function in this file.

---

## Technical Details

**Current broken flow for "ಇಂಗ್ಲೀಷ" subject:**
```
detectLanguage("Kannada", "ಇಂಗ್ಲೀಷ")
  → normalizedSubject = "ಇಂಗ್ಲೀಷ"
  → Does not include "kannada" → skip
  → Does not include "hindi" → skip
  → medium is "Kannada" (not "English") → skip
  → falls to default → returns "kannada"  ← WRONG
```

**Fixed flow:**
```
detectLanguage("Kannada", "ಇಂಗ್ಲೀಷ")
  → Does not include "kannada" → skip
  → Does not include "hindi" → skip
  → includes "ಇಂಗ್ಲೀಷ" → returns "english"  ← CORRECT
```

Both edge functions will be deployed after the fix. Cached quizzes for "ಇಂಗ್ಲೀಷ" chapters will need to be regenerated by clicking "New Quiz" — they won't auto-fix since the old wrong ones are cached.
